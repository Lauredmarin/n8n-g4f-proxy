name: Trigger Portainer webhook on push

on:
  push:
    branches:   
      - '**'

jobs:
  notify-portainer:
    runs-on: ubuntu-latest
    steps:
      - name: Send webhook to Portainer (using secret)
        env:
          WEBHOOK_URL: ${{ secrets.PORTAINER_WEBHOOK_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "ERROR: WEBHOOK_URL is empty. Add PORTAINER_WEBHOOK_URL secret to the repo."
            exit 1
          fi

          # simple JSON payload with basic info
          PAYLOAD=$(printf '{"ref":"%s","actor":"%s","repository":"%s","compare":"%s"}' "$GITHUB_REF" "$GITHUB_ACTOR" "$GITHUB_REPOSITORY" "$GITHUB_COMPARE_URL")

          echo "Sending webhook to Portainer..."
          curl -sS -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "$WEBHOOK_URL" || exit 2
          echo "Webhook sent."
